// La Pesqueria Outfitters E-Commerce Platform - Prisma Schema
// Self-hosted admin panel with full type safety

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  STAFF
  CUSTOMER
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum TransactionType {
  SALE
  RESTOCK
  ADJUSTMENT
  RESERVATION
}

enum DonationStatus {
  PLEDGED
  DONATED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  role          UserRole  @default(CUSTOMER)
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  orders                Order[]
  accounts              Account[]
  sessions              Session[]
  rewards               CustomerReward?
  prizeRedemptions      PrizeRedemption[]
  orderNotes            OrderNote[]
  reviews               ProductReview[]
  inventoryTransactions InventoryTransaction[]
  calendarEvents        CalendarEvent[]
  blogPosts             BlogPost[]             @relation("BlogAuthor")
  subscriptions         Subscription[]
  shippingAddresses     ShippingAddress[]
  staffInvites          StaffInvite[]
  activityLogs          ActivityLog[]
  supportTickets        SupportTicket[]
  ticketMessages        TicketMessage[]
  socialMediaPosts      SocialMediaPost[]      @relation("SocialMediaPosts")
  customerTags          CustomerTags[]

  @@map("users")
}

// NextAuth required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@map("categories")
}

model Product {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  sku         String  @unique
  basePrice   Float
  featured    Boolean @default(false)

  // Conservation info
  conservationPercentage Float   @default(10)
  conservationFocus      String?

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  // NFT Integration
  hasNFT          Boolean @default(false)
  nftCollectionId String?

  // Customization
  isCustomizable Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  variants             ProductVariant[]
  images               ProductImage[]
  reviews              ProductReview[]
  nftTokens            NFTToken[]
  customizationOptions ProductCustomizationOption[]

  @@map("products")
}

model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  name  String
  sku   String @unique
  price Float
  stock Int    @default(0)

  // Variant attributes
  size     String?
  color    String?
  material String?

  // AR/3D Model Support
  model3dGltf String? // GLTF/GLB URL for web AR
  model3dUsdz String? // USDZ URL for iOS AR Quick Look
  arEnabled   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderItems   OrderItem[]
  transactions InventoryTransaction[]
  images       ProductImage[]
  forecasts    InventoryForecast[]
  alerts       InventoryAlert[]

  @@map("product_variants")
}

model ProductImage {
  id       String  @id @default(cuid())
  url      String
  alt      String?
  position Int     @default(0)

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)

  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("product_images")
}

model Order {
  id          String @id @default(cuid())
  orderNumber String @unique @default(cuid())

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  // Customer info (for guest checkout)
  customerEmail String
  customerName  String

  // Shipping info
  shippingAddress String
  shippingCity    String
  shippingState   String
  shippingZip     String
  shippingCountry String @default("US")

  // Order totals
  subtotal Float
  shipping Float
  tax      Float
  total    Float

  status OrderStatus @default(PENDING)

  // Payment (Clover POS)
  cloverOrderId   String?
  cloverPaymentId String?

  // Shipping tracking
  trackingNumber String?
  carrier        String?
  shippingCost   Float     @default(0)
  shippedAt      DateTime?
  deliveredAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items                OrderItem[]
  conservationDonation ConservationDonation?
  notes                OrderNote[]
  returns              Return[]
  shippingLabels       ShippingLabel[]

  @@map("orders")
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  quantity Int
  price    Float

  createdAt DateTime @default(now())

  customizations OrderItemCustomization[]

  @@map("order_items")
}

model OrderNote {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  content String @db.Text

  createdAt DateTime @default(now())

  @@index([orderId])
  @@map("order_notes")
}

model InventoryTransaction {
  id        String         @id @default(cuid())
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  type     TransactionType
  quantity Int
  notes    String?

  createdAt DateTime @default(now())

  @@map("inventory_transactions")
}

model ConservationDonation {
  id      String @id @default(cuid())
  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  amount       Float
  percentage   Float
  organization String?
  region       String? // Rio Grande Valley, South Padre Island
  status       DonationStatus @default(PLEDGED)
  receiptUrl   String?

  partnerId String?
  partner   ConservationPartner? @relation(fields: [partnerId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("conservation_donations")
}

model SiteSettings {
  id           String   @id @default(cuid())
  siteName     String   @default("La Pesqueria Outfitters")
  logo         String?
  tagline      String?
  primaryColor String   @default("#001F3F")
  email        String?
  phone        String?
  address      String   @default("4400 N 23rd St Suite 135, McAllen, TX")
  facebook     String?
  instagram    String?
  twitter      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("site_settings")
}

// Newsletter Subscribers
model NewsletterSubscriber {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  isActive       Boolean   @default(true)
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?

  @@map("newsletter_subscribers")
}

// Customer Rewards & Gamification
model CustomerReward {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  points      Int      @default(0)
  totalSpent  Float    @default(0)
  totalOrders Int      @default(0)
  currentTier String   @default("Bronze") // Bronze, Silver, Gold, Platinum
  memberSince DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  achievements      CustomerAchievement[]
  pointTransactions PointTransaction[]

  @@map("customer_rewards")
}

// Point Transactions (earning and spending)
model PointTransaction {
  id         String         @id @default(cuid())
  customerId String
  customer   CustomerReward @relation(fields: [customerId], references: [id], onDelete: Cascade)

  points      Int // Positive for earning, negative for spending
  type        String // PURCHASE, SIGNUP, BIRTHDAY, REFERRAL, SPEND
  description String
  orderId     String?

  createdAt DateTime @default(now())

  @@map("point_transactions")
}

// Achievements/Badges
model Achievement {
  id          String @id @default(cuid())
  name        String
  description String
  icon        String @default("üèÜ")
  requirement String // Description of how to earn
  points      Int    @default(0) // Bonus points for earning this

  createdAt DateTime @default(now())

  customerAchievements CustomerAchievement[]

  @@map("achievements")
}

// Link between customers and their earned achievements
model CustomerAchievement {
  id         String         @id @default(cuid())
  customerId String
  customer   CustomerReward @relation(fields: [customerId], references: [id], onDelete: Cascade)

  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  earnedAt DateTime @default(now())

  @@unique([customerId, achievementId])
  @@map("customer_achievements")
}

// Reward Prizes (what customers can win/redeem)
model RewardPrize {
  id             String  @id @default(cuid())
  name           String
  description    String
  image          String?
  pointsCost     Int // How many points to redeem
  isActive       Boolean @default(true)
  stockAvailable Int     @default(0) // -1 for unlimited

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  redemptions PrizeRedemption[]

  @@map("reward_prizes")
}

// Prize Redemptions
model PrizeRedemption {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  prizeId String
  prize   RewardPrize @relation(fields: [prizeId], references: [id])

  pointsSpent     Int
  status          String  @default("PENDING") // PENDING, SHIPPED, DELIVERED
  trackingNumber  String?
  shippingAddress String?

  redeemedAt  DateTime  @default(now())
  shippedAt   DateTime?
  deliveredAt DateTime?

  @@map("prize_redemptions")
}

// Analytics Event Types
enum AnalyticsEventType {
  PRODUCT_VIEW
  ADD_TO_CART
  REMOVE_FROM_CART
  PURCHASE
  SEARCH
  CATEGORY_VIEW
}

// Analytics Events - Privacy-conscious event tracking
// Stores aggregated browsing behavior for recommendation improvement
// No PII (personally identifiable information) stored
model AnalyticsEvent {
  id String @id @default(cuid())

  // Event metadata
  eventType AnalyticsEventType
  timestamp DateTime           @default(now())

  // User tracking (anonymized session, optional user link)
  sessionId String // Anonymous session identifier
  userId    String? // Optional: linked user for personalization

  // Product interaction tracking
  productId  String?
  variantId  String?
  categoryId String?

  // Event-specific data (JSON for flexibility)
  metadata Json? // Additional context (price, quantity, search query, etc.)

  // Referrer and context (privacy-conscious)
  referrer   String? // Where user came from (page, not external sites)
  deviceType String? // mobile, tablet, desktop

  // Index for efficient querying
  @@index([eventType, timestamp])
  @@index([userId, timestamp])
  @@index([sessionId, timestamp])
  @@index([productId, timestamp])
  @@map("analytics_events")
}

// Aggregated Product Analytics - Privacy-conscious summary data
// Used for trending, popularity, and recommendation scoring
model ProductAnalytics {
  id        String @id @default(cuid())
  productId String @unique

  // View metrics (last 30 days rolling window)
  viewsLast7Days  Int @default(0)
  viewsLast30Days Int @default(0)

  // Cart metrics
  addToCartLast7Days  Int @default(0)
  addToCartLast30Days Int @default(0)

  // Purchase metrics
  purchasesLast7Days  Int @default(0)
  purchasesLast30Days Int @default(0)

  // Conversion rates (calculated)
  viewToCartRate     Float @default(0) // addToCart / views
  cartToPurchaseRate Float @default(0) // purchases / addToCart

  // Trending score (0-100, calculated daily)
  trendingScore Float @default(0)

  // Last updated timestamp
  lastUpdated DateTime @default(now()) @updatedAt

  @@map("product_analytics")
}

// User Browsing Patterns - Privacy-conscious behavioral summary
// Stores aggregated patterns, not individual events
model UserBrowsingPattern {
  id     String @id @default(cuid())
  userId String @unique

  // Category preferences (JSON array of {categoryId, score})
  categoryPreferences Json @default("[]")

  // Price range preferences
  avgPriceViewed Float?
  minPriceViewed Float?
  maxPriceViewed Float?

  // Conservation interests
  conservationInterests Json @default("[]") // Array of conservation focuses

  // Behavioral patterns
  totalViews      Int @default(0)
  totalAddToCarts Int @default(0)
  totalPurchases  Int @default(0)

  // Time-based patterns
  preferredBrowsingTimes Json @default("[]") // Hours of day when most active

  // Last updated
  lastActivity DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("user_browsing_patterns")
}

// ============================================================================
// DISCOUNT & PROMOTION SYSTEM
// ============================================================================

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_SHIPPING
  BUY_X_GET_Y
}

model DiscountCode {
  id    String       @id @default(cuid())
  code  String       @unique
  type  DiscountType
  value Float // Percentage (0-100) or fixed amount

  // Usage limits
  usageLimit            Int? // Max total uses
  usageLimitPerCustomer Int? // Max uses per customer
  usageCount            Int  @default(0)

  // Validity
  startsAt  DateTime?
  expiresAt DateTime?
  isActive  Boolean   @default(true)

  // Conditions
  minPurchaseAmount    Float? // Minimum order amount
  applicableProducts   String[] // Product IDs (empty = all)
  applicableCategories String[] // Category IDs (empty = all)

  // Metadata
  description  String?
  internalNote String? // Admin notes
  createdBy    String? // Admin user ID
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  usages DiscountUsage[]

  @@index([code])
  @@index([isActive, expiresAt])
  @@map("discount_codes")
}

model DiscountUsage {
  id             String       @id @default(cuid())
  discountId     String
  discount       DiscountCode @relation(fields: [discountId], references: [id], onDelete: Cascade)
  orderId        String
  userId         String?
  discountAmount Float
  usedAt         DateTime     @default(now())

  @@index([discountId])
  @@index([orderId])
  @@map("discount_usage")
}

// ============================================================================
// CONSERVATION ENHANCEMENT
// ============================================================================

model ConservationPartner {
  id           String  @id @default(cuid())
  name         String
  description  String
  logo         String?
  website      String?
  contactEmail String?

  // Focus areas
  focusAreas String[] // ["Sea Turtles", "Whales", "Coral Reefs"]
  location   String? // "South Padre Island", "Rio Grande Valley"

  // Metrics
  totalDonations Float @default(0)
  donationCount  Int   @default(0)

  // Status
  isActive   Boolean   @default(true)
  verifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  donations ConservationDonation[]

  @@map("conservation_partners")
}

model ConservationImpact {
  id String @id @default(cuid())

  // Time period
  periodStart DateTime
  periodEnd   DateTime
  periodType  String // "daily", "weekly", "monthly", "yearly"

  // Metrics
  totalDonations Float
  orderCount     Int

  // Impact estimates (calculated)
  turtlesSaved  Int? // Estimated based on donation amount
  oceanCleaned  Float? // Square meters
  coralRestored Float? // Square meters

  // Breakdown by focus
  focusBreakdown Json // { "Sea Turtles": 500, "Whales": 300, ... }

  createdAt DateTime @default(now())

  @@index([periodType, periodStart])
  @@map("conservation_impact")
}

// ============================================================================
// PRODUCT REVIEWS
// ============================================================================

model ProductReview {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Review content
  rating Int // 1-5 stars
  title  String?
  body   String
  photos String[] // Photo URLs

  // Customer info (for non-logged-in reviews)
  customerName  String?
  customerEmail String?

  // Moderation
  isApproved         Boolean   @default(false)
  isRejected         Boolean   @default(false)
  isVerifiedPurchase Boolean   @default(false)
  moderatedBy        String? // Admin user ID
  moderatedAt        DateTime?

  // Engagement
  helpfulCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, isApproved])
  @@index([rating])
  @@map("product_reviews")
}

// ============================================================================
// EMAIL SYSTEM
// ============================================================================

enum EmailTemplate {
  ORDER_CONFIRMATION
  SHIPPING_NOTIFICATION
  DELIVERY_CONFIRMATION
  ABANDONED_CART
  WELCOME
  PASSWORD_RESET
  NEWSLETTER
  PRODUCT_BACK_IN_STOCK
  ADMIN_CUSTOM
}

model EmailLog {
  id       String        @id @default(cuid())
  to       String
  subject  String
  template EmailTemplate

  // Content
  htmlContent String? @db.Text
  variables   Json? // Template variables

  // Status
  status     String // sent, failed, pending, bounced
  provider   String? // resend, sendgrid, etc
  providerId String? // External email ID

  // Tracking
  openedAt  DateTime?
  clickedAt DateTime?

  // Archive flag for admin email client
  archived Boolean @default(false)

  // Error handling
  error      String?
  retryCount Int     @default(0)

  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([to, createdAt])
  @@index([status])
  @@index([template])
  @@index([archived])
  @@map("email_logs")
}

// === SOCIAL MEDIA AUTOMATION ===

model SocialMediaPost {
  id            String   @id @default(cuid())
  platform      String   // instagram, facebook, twitter, pinterest
  content       String   @db.Text
  hashtags      String[]
  imageUrl      String?
  scheduledAt   DateTime
  postedAt      DateTime?
  status        String   @default("scheduled") // scheduled, posting, posted, failed
  errorMessage  String?  @db.Text
  
  // Relationship to user who created it
  createdById   String
  createdBy     User     @relation("SocialMediaPosts", fields: [createdById], references: [id], onDelete: Cascade)
  
  // Analytics
  postUrl       String?  // URL after posting
  engagement    Json?    // likes, comments, shares
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([scheduledAt])
  @@index([status])
  @@index([createdById])
  @@index([platform])
}

// ============================================================================
// CALENDAR & EVENTS
// ============================================================================

model CalendarEvent {
  id          String  @id @default(cuid())
  title       String
  description String? @db.Text

  // Date and time
  date    DateTime
  time    String? // Store as HH:MM format (optional for all-day events)
  endTime String? // Optional end time
  allDay  Boolean  @default(false)

  // Categorization
  category String @default("general") // general, meeting, deadline, personal, marketing, goal, task, note
  color    String @default("from-blue-500 to-cyan-500") // Tailwind gradient

  // Location and attendees
  location  String?
  attendees String[] // Names or email addresses

  // Recurring events
  recurring        Boolean   @default(false)
  recurringPattern String? // daily, weekly, monthly, yearly
  recurringEnd     DateTime?

  // Reminders
  reminder     Boolean @default(false)
  reminderTime Int? // Minutes before event

  // Status
  status String @default("scheduled") // scheduled, completed, cancelled, in_progress

  // === BUSINESS JOURNAL FEATURES ===

  // Priority for task management
  priority String @default("medium") // low, medium, high, urgent

  // Tags for flexible categorization
  tags String[] // Custom tags like "sales", "inventory", "client"

  // Journal/Notes entry (extended notes for business journaling)
  journalEntry String? @db.Text

  // Business metrics tracking
  projectedRevenue Float? // Expected revenue for this event/task
  actualRevenue    Float? // Actual revenue achieved

  // Task completion tracking
  completionPercent Int   @default(0) // 0-100 for progress tracking
  checklist         Json? // JSON array of checklist items [{text: string, done: boolean}]

  // Links and references
  links String[] // Related URLs or references

  // Owner
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, date])
  @@index([date])
  @@index([category])
  @@index([priority])
  @@map("calendar_events")
}

// ============================================================================
// SHIPPING MANAGEMENT
// ============================================================================

model ShippingZone {
  id        String   @id @default(cuid())
  name      String
  countries String[] // ISO country codes
  states    String[] // State codes (for US)
  zipCodes  String[] // Zip code patterns

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rates ShippingRate[]

  @@map("shipping_zones")
}

model ShippingRate {
  id     String       @id @default(cuid())
  zoneId String
  zone   ShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Pricing
  basePrice     Float
  pricePerPound Float? // Additional charge per pound
  freeAbove     Float? // Free shipping threshold

  // Conditions
  minWeight Float?
  maxWeight Float?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([zoneId])
  @@map("shipping_rates")
}

model ShippingLabel {
  id      String  @id @default(cuid())
  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id])

  carrier        String // USPS, FedEx, UPS
  service        String // Priority, Express, Ground
  trackingNumber String?
  labelUrl       String? // PDF URL

  cost   Float
  weight Float?
  length Float?
  width  Float?
  height Float?

  status String @default("created") // created, printed, shipped, delivered, void

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  printedAt   DateTime?
  shippedAt   DateTime?
  deliveredAt DateTime?

  @@index([orderId])
  @@index([trackingNumber])
  @@map("shipping_labels")
}

// ============================================================================
// BLOG MANAGEMENT SYSTEM
// ============================================================================

model BlogPost {
  id            String    @id @default(cuid())
  title         String
  slug          String    @unique
  excerpt       String?   @db.Text
  content       String    @db.Text
  featuredImage String?
  category      String?
  tags          String[] // Array of tags
  featured      Boolean   @default(false)
  published     Boolean   @default(false)
  publishedAt   DateTime?

  // Author relationship
  authorId String
  author   User   @relation("BlogAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for performance
  @@index([slug])
  @@index([category])
  @@index([published, publishedAt])
  @@index([featured, published])
  @@index([authorId])
  @@map("blog_posts")
}

// ============================================================================
// SUBSCRIPTION MODEL - "Ocean Guardian" Box
// ============================================================================

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  PAST_DUE
  TRIALING
}

enum SubscriptionTier {
  BASIC
  PREMIUM
  COLLECTOR
}

model SubscriptionPlan {
  id            String           @id @default(cuid())
  name          String
  tier          SubscriptionTier @unique
  description   String           @db.Text
  priceMonthly  Float
  cloverItemGroupId String?      @unique

  // Plan benefits
  apparelPerMonth    Int     @default(1)
  exclusiveDiscounts Boolean @default(false)
  earlyAccess        Boolean @default(false)
  limitedEditions    Boolean @default(false)
  vipPerks           Boolean @default(false)

  // Display
  features   String[] // List of features for display
  badgeColor String? // Color for subscriber badge
  isActive   Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  planId String
  plan   SubscriptionPlan @relation(fields: [planId], references: [id])

  status SubscriptionStatus @default(ACTIVE)

  // Clover integration
  cloverSubscriptionId String? @unique
  cloverCustomerId     String?

  // Billing period
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd  Boolean   @default(false)
  cancelledAt        DateTime?

  // Shipping preferences
  shippingAddressId  String?
  shippingAddress    ShippingAddress? @relation(fields: [shippingAddressId], references: [id])
  preferredSize      String? // S, M, L
  preferredColors    String[] // Preferred color palette
  preferredMaterials String[] // Preferred materials

  // Trial
  trialEndsAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shipments SubscriptionShipment[]

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

model SubscriptionShipment {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Period this shipment covers
  periodStart DateTime
  periodEnd   DateTime

  // Status
  status String @default("pending") // pending, preparing, shipped, delivered

  // Tracking
  trackingNumber String?
  carrier        String?
  labelUrl       String?

  // Contents
  items Json // Array of {productId, variantId, name, quantity}

  // Dates
  shippedAt   DateTime?
  deliveredAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([status])
  @@map("subscription_shipments")
}

model ShippingAddress {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name    String
  street1 String
  street2 String?
  city    String
  state   String
  zip     String
  country String  @default("US")
  phone   String?

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]

  @@index([userId])
  @@map("shipping_addresses")
}

// ============================================================================
// NFT INTEGRATION - Polygon
// ============================================================================

model NFTCollection {
  id              String  @id @default(cuid())
  name            String
  description     String? @db.Text
  contractAddress String? @unique
  symbol          String?
  baseUri         String?

  // Supply
  maxSupply     Int?
  currentSupply Int  @default(0)

  // Royalties
  royaltyPercent   Float   @default(5)
  royaltyRecipient String? // Wallet address

  // Metadata
  coverImage  String?
  bannerImage String?

  // Status
  isActive   Boolean   @default(true)
  deployedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tokens NFTToken[]

  @@map("nft_collections")
}

model NFTToken {
  id           String        @id @default(cuid())
  collectionId String
  collection   NFTCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  tokenId     Int // On-chain token ID
  name        String
  description String? @db.Text

  // Media
  imageUrl     String?
  animationUrl String? // For animated NFTs
  metadataUrl  String? // IPFS metadata URL

  // Product link
  productId String?
  product   Product? @relation(fields: [productId], references: [id])
  orderId   String? // Order that triggered mint

  // Ownership
  ownerAddress  String? // Current owner wallet
  originalOwner String? // First owner wallet

  // Minting status
  isMinted Boolean   @default(false)
  mintedAt DateTime?
  txHash   String? // Mint transaction hash

  // Attributes (for marketplace display)
  attributes Json? // Array of {trait_type, value}

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([collectionId, tokenId])
  @@index([ownerAddress])
  @@index([productId])
  @@map("nft_tokens")
}

// ============================================================================
// PERSONALIZATION / CUSTOMIZATION
// ============================================================================

enum CustomizationType {
  ENGRAVING
  CHARM
  COLOR
  MATERIAL
  BEAD_SELECTION
}

model CustomizationOption {
  id          String            @id @default(cuid())
  name        String
  type        CustomizationType
  description String?

  // Pricing
  priceModifier Float @default(0) // Additional cost

  // Constraints (for engravings)
  maxLength    Int? // Max characters
  allowedChars String? // Regex pattern for allowed characters

  // Display
  previewImage String?
  displayOrder Int     @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  productOptions          ProductCustomizationOption[]
  orderItemCustomizations OrderItemCustomization[]

  @@map("customization_options")
}

model ProductCustomizationOption {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  optionId String
  option   CustomizationOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  isRequired Boolean @default(false)
  isEnabled  Boolean @default(true)

  createdAt DateTime @default(now())

  @@unique([productId, optionId])
  @@map("product_customization_options")
}

model OrderItemCustomization {
  id          String    @id @default(cuid())
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  optionId String
  option   CustomizationOption @relation(fields: [optionId], references: [id])

  value      String // The customization value (text, charm ID, color code, etc.)
  priceAdded Float  @default(0)

  createdAt DateTime @default(now())

  @@index([orderItemId])
  @@map("order_item_customizations")
}

model CharmCatalog {
  id          String  @id @default(cuid())
  name        String
  description String?
  imageUrl    String
  price       Float   @default(0)

  // Categorization
  category String? // "ocean", "animals", "symbols", "letters"
  tags     String[]

  // Inventory
  stock    Int     @default(0)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("charm_catalog")
}

// ============================================================================
// RETURNS & REFUNDS
// ============================================================================

enum ReturnStatus {
  PENDING // Customer requested return
  APPROVED // Return approved, waiting for item
  RECEIVED // Item received at warehouse
  INSPECTING // Quality inspection in progress
  REFUND_PENDING // Approved for refund
  REFUNDED // Refund processed
  REJECTED // Return rejected
  CANCELLED // Customer cancelled request
}

enum ReturnReason {
  DEFECTIVE
  WRONG_ITEM
  NOT_AS_DESCRIBED
  CHANGED_MIND
  SIZE_ISSUE
  QUALITY_ISSUE
  ARRIVED_LATE
  OTHER
}

model Return {
  id           String @id @default(cuid())
  returnNumber String @unique @default(cuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  // Customer info
  customerEmail String
  customerName  String
  customerPhone String?

  // Return details
  reason        ReturnReason
  reasonDetails String?      @db.Text
  status        ReturnStatus @default(PENDING)

  // Return shipping
  returnLabelUrl       String?
  returnTrackingNumber String?
  returnCarrier        String?

  // Refund info
  refundAmount   Float?
  refundMethod   String? // original_payment, store_credit
  refundedAt     DateTime?
  cloverRefundId String?

  // Processing
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  receivedAt      DateTime?
  inspectedAt     DateTime?

  // Admin notes
  internalNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items ReturnItem[]

  @@index([orderId])
  @@index([status])
  @@index([customerEmail])
  @@map("returns")
}

model ReturnItem {
  id       String @id @default(cuid())
  returnId String
  return   Return @relation(fields: [returnId], references: [id], onDelete: Cascade)

  orderItemId String
  variantId   String
  productName String
  variantName String?
  quantity    Int
  unitPrice   Float

  // Inspection results
  condition   String? // new, like_new, damaged, unsellable
  restockable Boolean @default(true)

  createdAt DateTime @default(now())

  @@index([returnId])
  @@map("return_items")
}

// ============================================================================
// STAFF MANAGEMENT
// ============================================================================

model StaffInvite {
  id    String   @id @default(cuid())
  email String   @unique
  role  UserRole @default(STAFF)
  token String   @unique @default(cuid())

  invitedBy String
  inviter   User   @relation(fields: [invitedBy], references: [id])

  acceptedAt DateTime?
  expiresAt  DateTime

  createdAt DateTime @default(now())

  @@index([token])
  @@map("staff_invites")
}

model ActivityLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  action     String // create, update, delete, login, logout, etc.
  resource   String // order, product, customer, etc.
  resourceId String?
  details    Json?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@map("activity_logs")
}

// ============================================================================
// SUPPORT TICKETS (Phase 3)
// ============================================================================

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model SupportTicket {
  id           String @id @default(cuid())
  ticketNumber String @unique @default(cuid())

  // Customer info
  customerId    String?
  customer      User?   @relation(fields: [customerId], references: [id])
  customerEmail String
  customerName  String

  // Ticket details
  subject     String
  description String @db.Text
  category    String @default("general") // general, order, shipping, return, product, other

  status   TicketStatus   @default(OPEN)
  priority TicketPriority @default(MEDIUM)

  // Assignment
  assignedTo String?

  // Related entities
  orderId  String?
  returnId String?

  // Resolution
  resolvedAt DateTime?
  resolution String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages TicketMessage[]

  @@index([customerId])
  @@index([status])
  @@index([priority])
  @@map("support_tickets")
}

model TicketMessage {
  id       String        @id @default(cuid())
  ticketId String
  ticket   SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  senderId    String?
  sender      User?   @relation(fields: [senderId], references: [id])
  senderEmail String
  senderName  String
  isStaff     Boolean @default(false)

  content     String   @db.Text
  attachments String[]

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@map("ticket_messages")
}

// Email Marketing Campaign System
enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
}

enum CampaignType {
  NEWSLETTER
  PROMOTIONAL
  ABANDONED_CART
  WELCOME
  REENGAGEMENT
  ANNOUNCEMENT
  CUSTOM
}

model EmailCampaign {
  id          String         @id @default(cuid())
  name        String
  subject     String
  preheader   String?
  content     String         @db.Text
  type        CampaignType   @default(NEWSLETTER)
  status      CampaignStatus @default(DRAFT)

  // Targeting
  targetAudience   String?   // JSON filter criteria
  segmentName      String?   // Human-readable segment name
  recipientCount   Int       @default(0)

  // Scheduling
  scheduledAt      DateTime?
  sentAt           DateTime?
  completedAt      DateTime?

  // Stats
  totalSent        Int       @default(0)
  totalDelivered   Int       @default(0)
  totalOpened      Int       @default(0)
  totalClicked     Int       @default(0)
  totalBounced     Int       @default(0)
  totalUnsubscribed Int      @default(0)

  // Metadata
  createdById String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  recipients CampaignRecipient[]

  @@index([status])
  @@index([type])
  @@index([scheduledAt])
  @@map("email_campaigns")
}

model CampaignRecipient {
  id         String        @id @default(cuid())
  campaignId String
  campaign   EmailCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  email      String
  name       String?
  userId     String?

  // Delivery status
  sentAt        DateTime?
  deliveredAt   DateTime?
  openedAt      DateTime?
  clickedAt     DateTime?
  bouncedAt     DateTime?
  unsubscribedAt DateTime?

  // Error tracking
  errorMessage  String?

  createdAt DateTime @default(now())

  @@unique([campaignId, email])
  @@index([campaignId])
  @@index([email])
  @@map("campaign_recipients")
}

// SEO Management System
model SEOSettings {
  id          String   @id @default(cuid())
  pageType    String   // 'home', 'product', 'category', 'blog', 'custom'
  pageId      String?  // Reference to specific product/category/blog id
  slug        String?  // URL path for custom pages

  // Meta tags
  metaTitle       String?
  metaDescription String?  @db.Text
  metaKeywords    String?
  canonicalUrl    String?

  // Open Graph
  ogTitle         String?
  ogDescription   String?  @db.Text
  ogImage         String?
  ogType          String?  @default("website")

  // Twitter Card
  twitterCard     String?  @default("summary_large_image")
  twitterTitle    String?
  twitterDescription String? @db.Text
  twitterImage    String?

  // Schema.org structured data (JSON-LD)
  structuredData  String?  @db.Text

  // Robots
  noIndex         Boolean  @default(false)
  noFollow        Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pageType, pageId])
  @@index([pageType])
  @@map("seo_settings")
}

model Redirect {
  id          String   @id @default(cuid())
  fromPath    String   @unique
  toPath      String
  statusCode  Int      @default(301) // 301 permanent, 302 temporary
  isActive    Boolean  @default(true)
  hitCount    Int      @default(0)
  lastHitAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fromPath])
  @@index([isActive])
  @@map("redirects")
}

model SitemapEntry {
  id          String   @id @default(cuid())
  url         String   @unique
  changeFreq  String   @default("weekly") // always, hourly, daily, weekly, monthly, yearly, never
  priority    Float    @default(0.5) // 0.0 to 1.0
  lastMod     DateTime @default(now())
  isActive    Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@map("sitemap_entries")
}

// Inventory Forecasting System
model InventoryForecast {
  id          String   @id @default(cuid())
  variantId   String
  variant     ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  // Time period
  periodStart DateTime
  periodEnd   DateTime
  periodType  String   // 'day', 'week', 'month'

  // Forecasted data
  forecastedDemand    Int
  forecastedSales     Float
  confidence          Float    @default(0.8)
  seasonalityFactor   Float    @default(1.0)

  // Recommendations
  recommendedReorder  Int      @default(0)
  reorderPoint        Int      @default(0)
  safetyStock         Int      @default(0)

  // Calculated at
  calculatedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([variantId, periodStart, periodType])
  @@index([variantId])
  @@index([periodStart])
  @@map("inventory_forecasts")
}

model InventoryAlert {
  id          String   @id @default(cuid())
  variantId   String
  variant     ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  alertType   String   // 'low_stock', 'out_of_stock', 'overstock', 'reorder'
  severity    String   @default("medium") // 'low', 'medium', 'high', 'critical'
  message     String
  currentStock Int
  threshold   Int?

  isRead      Boolean  @default(false)
  resolvedAt  DateTime?

  createdAt DateTime @default(now())

  @@index([variantId])
  @@index([isRead])
  @@index([alertType])
  @@map("inventory_alerts")
}

// ============================================================================
// T-SHIRT INVENTORY MANAGEMENT
// ============================================================================

// T-shirt categories for organizing products
model TShirtCategory {
  id          String  @id @default(cuid())
  name        String  // e.g., "Ocean Theme", "Conservation", "Marine Life"
  slug        String  @unique
  description String?
  imageUrl    String?
  isActive    Boolean @default(true)
  displayOrder Int    @default(0)

  products TShirtProduct[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([displayOrder])
  @@map("tshirt_categories")
}

// Available T-shirt colors
model TShirtColor {
  id          String  @id @default(cuid())
  name        String  @unique // e.g., "White", "Navy", "Seafoam", "Coral", "Black"
  hexCode     String? // Hex color code for UI display
  isActive    Boolean @default(true)
  displayOrder Int    @default(0)

  inventory TShirtInventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([displayOrder])
  @@map("tshirt_colors")
}

// T-shirt sizes
model TShirtSize {
  id          String  @id @default(cuid())
  name        String  @unique // e.g., "XS", "S", "M", "L", "XL", "XXL", "3XL"
  label       String  // e.g., "Extra Small", "Small", "Medium", etc.
  chestWidth  String? // e.g., "34-36", "36-38", etc.
  length      String? // e.g., "26", "28", etc.
  isActive    Boolean @default(true)
  displayOrder Int    @default(0)

  inventory TShirtInventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([displayOrder])
  @@map("tshirt_sizes")
}

// T-shirt products
model TShirtProduct {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  basePrice   Float
  imageUrl    String?
  isActive    Boolean @default(true)

  categoryId String?
  category   TShirtCategory? @relation(fields: [categoryId], references: [id])

  inventory TShirtInventory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([slug])
  @@map("tshirt_products")
}

// T-shirt inventory - tracks stock levels
model TShirtInventory {
  id          String  @id @default(cuid())
  
  productId   String
  product     TShirtProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  colorId     String
  color       TShirtColor @relation(fields: [colorId], references: [id])
  
  sizeId      String
  size        TShirtSize @relation(fields: [sizeId], references: [id])
  
  stock       Int      @default(0)
  price       Float    @default(0)
  sku         String?  @unique
  
  reorderPoint Int     @default(10)
  safetyStock  Int     @default(5)
  
  // Tracking
  lastRestockAt DateTime?
  lastSaleAt    DateTime?
  
  // Relations
  transactions TShirtInventoryTransaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, colorId, sizeId])
  @@index([productId])
  @@index([colorId])
  @@index([sizeId])
  @@index([stock])
  @@map("tshirt_inventory")
}

// T-shirt inventory transactions (for audit trail)
model TShirtInventoryTransaction {
  id          String         @id @default(cuid())
  inventoryId String
  inventory   TShirtInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  
  type        TransactionType
  quantity    Int
  reason      String?
  
  createdAt DateTime @default(now())

  @@index([inventoryId])
  @@map("tshirt_inventory_transactions")
}

// ============================================================================
// CUSTOMER SEGMENTATION
// ============================================================================

model CustomerTag {
  id          String   @id @default(cuid())
  name        String   @unique
  color       String   @default("#3B82F6") // Default blue
  description String?
  isAutomatic Boolean  @default(false) // Auto-applied based on rules
  
  // Rules for automatic tagging (JSON)
  // { "minOrders": 5, "maxOrders": null, "minSpent": 500, "lastOrderDaysAgo": 90 }
  rules       Json?
  
  customerCount Int     @default(0)
  isActive      Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  customers   CustomerTags[]
  
  @@map("customer_tags")
}

model CustomerTags {
  id        String       @id @default(cuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  tagId     String
  tag       CustomerTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())
  
  @@unique([userId, tagId])
  @@map("customer_tags_relation")
}

model CustomerSegment {
  id     String @id @default(cuid())
  name   String @unique
  description String?
  
  // Rules defining who belongs to this segment (JSON)
  // { "tags": ["VIP", "Repeat Buyer"], "minOrders": 5, "maxOrders": null, "minSpent": 500 }
  rules  Json
  
  customerCount Int      @default(0)
  isActive      Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("customer_segments")
}

// ============================================================================
// REVIEW REQUEST AUTOMATION
// ============================================================================

enum ReviewRequestStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  REVIEWED
  FAILED
}

model ReviewRequestWorkflow {
  id     String @id @default(cuid())
  name   String
  
  // Trigger configuration
  triggerType    String  @default("order_delivered") // order_delivered, order_completed
  triggerDelayHours Int @default(72) // Send 3 days after trigger
  
  // Email template
  subject String
  body    String   @db.Text // HTML template with variables
  
  // Variables for personalization (JSON)
  // { "includeProducts": true, "includeImages": true, "includeIncentive": true }
  templateConfig Json   @default("{}")
  
  // Incentive
  incentiveType   String? // discount, store_credit, loyalty_points
  incentiveValue  Float?
  incentiveMinRating Int? // Only give incentive for ratings >= X
  
  // Channel
  channel String @default("email") // email, sms, both
  
  // Reminders
  remindersEnabled   Boolean @default(true)
  remindersCount     Int     @default(2)
  remindersIntervalDays Int  @default(7)
  
  // Targeting
  targetSegments   String[] @default([]) // Customer segment IDs
  excludeSegments  String[] @default([])
  minOrderValue    Float?
  
  // Stats
  totalSent     Int     @default(0)
  totalOpened   Int     @default(0)
  totalClicked  Int     @default(0)
  totalReviewed Int     @default(0)
  
  isActive Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  logs ReviewRequestLog[]
  
  @@map("review_request_workflows")
}

model ReviewRequestLog {
  id         String              @id @default(cuid())
  workflowId String
  workflow   ReviewRequestWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  orderId    String
  customerId String?
  customerEmail String

  // Email details
  subject    String
  providerId String? // Resend/SendGrid message ID

  status     ReviewRequestStatus @default(PENDING)

  sentAt     DateTime?
  openedAt   DateTime?
  clickedAt  DateTime?
  reviewedAt DateTime?

  // Reminder tracking
  reminderNumber Int @default(0)

  // Error handling
  errorMessage String?
  retryCount   Int  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workflowId])
  @@index([orderId])
  @@index([status])
  @@map("review_request_logs")
}

// ============================================================================
// CLOVER POS INTEGRATION
// ============================================================================

enum CloverSyncStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  PARTIAL
}

// Store Clover API configuration securely
model CloverConfig {
  id            String   @id @default(cuid())
  merchantId    String   @unique
  merchantName  String?

  // OAuth tokens (encrypted in production)
  accessToken   String   @db.Text
  refreshToken  String?  @db.Text
  tokenExpiresAt DateTime?

  // API Configuration
  environment   String   @default("production") // sandbox, production
  apiVersion    String   @default("v3")

  // Sync settings
  autoSyncEnabled    Boolean @default(true)
  syncIntervalMinutes Int    @default(30)
  lastSyncAt         DateTime?

  // What to sync
  syncProducts    Boolean @default(true)
  syncCategories  Boolean @default(true)
  syncOrders      Boolean @default(true)
  syncCustomers   Boolean @default(true)
  syncInventory   Boolean @default(true)
  syncModifiers   Boolean @default(true)

  // Webhook configuration
  webhookSecret   String?
  webhookEnabled  Boolean @default(false)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  syncLogs CloverSyncLog[]
  items    CloverItem[]
  orders   CloverOrder[]

  @@map("clover_config")
}

// Track sync history
model CloverSyncLog {
  id          String           @id @default(cuid())
  configId    String
  config      CloverConfig     @relation(fields: [configId], references: [id], onDelete: Cascade)

  syncType    String           // full, incremental, items, orders, customers, inventory
  status      CloverSyncStatus @default(PENDING)

  // Stats
  itemsSynced      Int @default(0)
  itemsCreated     Int @default(0)
  itemsUpdated     Int @default(0)
  itemsFailed      Int @default(0)

  ordersSynced     Int @default(0)
  customersSynced  Int @default(0)
  categoriesSynced Int @default(0)
  modifiersSynced  Int @default(0)

  // Timing
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  durationMs  Int?

  // Error handling
  errorMessage String?  @db.Text
  errorDetails Json?

  // Triggered by
  triggeredBy String   @default("system") // system, manual, webhook
  userId      String?  // Admin user who triggered manual sync

  createdAt DateTime @default(now())

  @@index([configId])
  @@index([status])
  @@index([syncType])
  @@map("clover_sync_logs")
}

// Mirror Clover items for real-time sync
model CloverItem {
  id            String       @id @default(cuid())
  configId      String
  config        CloverConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  // Clover identifiers
  cloverId      String       @unique
  cloverItemId  String?      // Original item ID from Clover

  // Item details from Clover
  name          String
  alternateName String?
  sku           String?
  price         Int          // Price in cents
  priceType     String       @default("FIXED") // FIXED, VARIABLE, PER_UNIT
  unitName      String?

  // Stock tracking
  stockCount    Int          @default(0)
  isStockTracked Boolean     @default(true)

  // Category from Clover
  cloverCategoryId   String?
  cloverCategoryName String?

  // Tax rates
  taxRateIds    String[]
  isRevenue     Boolean      @default(true)

  // Modifiers
  modifierGroupIds String[]

  // Display
  imageUrl      String?
  isHidden      Boolean      @default(false)

  // Link to local product (for two-way sync)
  localProductId String?     @unique
  localVariantId String?

  // Sync metadata
  lastSyncedAt  DateTime     @default(now())
  cloverModifiedAt DateTime?

  // Cost tracking
  cost          Int?         // Cost in cents for margin calculation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lineItems CloverOrderLineItem[]

  @@index([configId])
  @@index([cloverId])
  @@index([sku])
  @@index([localProductId])
  @@map("clover_items")
}

// Mirror Clover orders
model CloverOrder {
  id           String       @id @default(cuid())
  configId     String
  config       CloverConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  // Clover identifiers
  cloverId     String       @unique

  // Order details
  state        String       // OPEN, LOCKED, PAID, etc.
  title        String?
  note         String?

  // Totals (in cents)
  total        Int          @default(0)
  subtotal     Int          @default(0)
  taxAmount    Int          @default(0)
  tipAmount    Int          @default(0)
  discountAmount Int        @default(0)
  serviceCharge Int         @default(0)

  // Customer
  cloverCustomerId   String?
  customerName       String?
  customerEmail      String?
  customerPhone      String?

  // Employee who created order
  cloverEmployeeId   String?
  employeeName       String?

  // Device info
  deviceId     String?

  // Timestamps from Clover
  cloverCreatedAt  DateTime?
  cloverModifiedAt DateTime?

  // Payment info
  paymentState String?      // OPEN, PAID, REFUNDED
  paymentIds   String[]

  // Order type
  orderType    String?      // DINE_IN, TAKE_OUT, DELIVERY

  // Link to local order (for sync)
  localOrderId String?      @unique

  // Sync metadata
  lastSyncedAt DateTime     @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lineItems CloverOrderLineItem[]
  payments  CloverPayment[]

  @@index([configId])
  @@index([cloverId])
  @@index([state])
  @@index([localOrderId])
  @@map("clover_orders")
}

// Clover order line items
model CloverOrderLineItem {
  id           String      @id @default(cuid())
  orderId      String
  order        CloverOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Clover identifiers
  cloverId     String

  // Item reference
  cloverItemId String?
  item         CloverItem? @relation(fields: [cloverItemId], references: [cloverId])

  // Line item details
  name         String
  alternateName String?
  price        Int         // Price in cents
  unitPrice    Int?
  quantity     Int         @default(1)

  // Discounts & modifications
  discountAmount Int       @default(0)
  modifiers    Json?       // Array of modifier details

  // Notes
  note         String?

  // Tax
  taxAmount    Int         @default(0)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([cloverItemId])
  @@map("clover_order_line_items")
}

// Clover payments
model CloverPayment {
  id           String      @id @default(cuid())
  orderId      String
  order        CloverOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Clover identifiers
  cloverId     String      @unique

  // Payment details
  amount       Int         // Amount in cents
  tipAmount    Int         @default(0)
  taxAmount    Int         @default(0)

  // Payment method
  tender       String?     // CREDIT_CARD, CASH, etc.
  cardType     String?     // VISA, MASTERCARD, etc.
  last4        String?     // Last 4 digits of card

  // Status
  result       String      // SUCCESS, FAIL, etc.

  // External references
  externalPaymentId String?

  // Timestamps
  cloverCreatedAt DateTime?

  createdAt DateTime @default(now())

  @@index([orderId])
  @@map("clover_payments")
}

// Clover modifiers and modifier groups
model CloverModifierGroup {
  id               String   @id @default(cuid())
  cloverId         String   @unique
  merchantId       String

  name             String
  showByDefault    Boolean  @default(true)

  // Selection rules
  minRequired      Int      @default(0)
  maxAllowed       Int?

  // Item associations
  itemIds          String[]

  lastSyncedAt     DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  modifiers CloverModifier[]

  @@index([merchantId])
  @@map("clover_modifier_groups")
}

model CloverModifier {
  id            String              @id @default(cuid())
  cloverId      String              @unique
  groupId       String
  group         CloverModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  name          String
  alternateName String?
  price         Int                 @default(0) // Price in cents

  available     Boolean             @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([groupId])
  @@map("clover_modifiers")
}

// Clover tax rates
model CloverTaxRate {
  id           String   @id @default(cuid())
  cloverId     String   @unique
  merchantId   String

  name         String
  rate         Int      // Tax rate as basis points (e.g., 825 = 8.25%)
  isDefault    Boolean  @default(false)

  // What it applies to
  taxableAmount String  @default("SUBTOTAL") // SUBTOTAL, NET

  lastSyncedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchantId])
  @@map("clover_tax_rates")
}

// Clover customers
model CloverCustomer {
  id              String   @id @default(cuid())
  cloverId        String   @unique
  merchantId      String

  firstName       String?
  lastName        String?

  // Contact info
  emailAddresses  String[]
  phoneNumbers    String[]

  // Address
  addresses       Json?    // Array of address objects

  // Marketing preferences
  marketingAllowed Boolean @default(false)

  // Metrics
  orderCount      Int      @default(0)
  totalSpent      Int      @default(0) // In cents

  // Link to local user
  localUserId     String?  @unique

  // Timestamps
  cloverCreatedAt DateTime?
  lastSyncedAt    DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([merchantId])
  @@index([localUserId])
  @@map("clover_customers")
}
